name: Telegram Auto Post

on:
  workflow_dispatch:
  schedule:
    - cron: "2/5 * * * *"

permissions:
  contents: write

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install deps
        run: pip install requests pikepdf

      - name: Run bot
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          DEST_CHANNEL: ${{ secrets.DEST_CHANNEL }}
          FEED_URL: ${{ secrets.FEED_URL }}
          FOLLOW_LINE: "ðŸ“¢ Follow @topgkguru"
        run: python bot.py

      - name: Commit last.txt state
        run: |
          if [ -f last.txt ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add last.txt
            git commit -m "Update last state" || true
            git push || true
          else
            echo "last.txt not found, nothing to commit"
          fi
